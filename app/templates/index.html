<!DOCTYPE html>
<html>
<head>
  <title>US Postal Duty Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://design.avalara.com/assets/avalara-design-tokens.css" rel="stylesheet">
  <link href="https://design.avalara.com/assets/avalara-components.css" rel="stylesheet">
  <style>
    /* Using Avalara Design System tokens */
    :root {
      --av-color-primary: #0059b3;
      --av-color-primary-light: #e6f3ff;
      --av-color-success: #22c55e;
      --av-color-danger: #ef4444;
      --av-color-warning: #f59e0b;
      --av-color-gray-50: #f9fafb;
      --av-color-gray-100: #f3f4f6;
      --av-color-gray-200: #e5e7eb;
      --av-color-gray-600: #4b5563;
      --av-color-gray-900: #111827;
      --av-border-radius: 8px;
      --av-spacing-xs: 0.25rem;
      --av-spacing-sm: 0.5rem;
      --av-spacing-md: 1rem;
      --av-spacing-lg: 1.5rem;
      --av-font-size-sm: 0.875rem;
      --av-font-size-base: 1rem;
      --av-font-size-lg: 1.125rem;
    }

    body {
      background-color: #ffffff;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--av-color-gray-900);
      font-size: var(--av-font-size-sm);
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--av-spacing-md);
    }

    .calculator-card {
      background: white;
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-border-radius);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .header-section {
      background: var(--av-color-primary);
      color: white;
      padding: var(--av-spacing-md) var(--av-spacing-lg);
      border-radius: var(--av-border-radius) var(--av-border-radius) 0 0;
    }

    .header-section h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
    }

    .header-section p {
      margin: var(--av-spacing-xs) 0 0 0;
      opacity: 0.9;
      font-weight: 400;
      font-size: var(--av-font-size-sm);
    }

    .form-section {
      padding: var(--av-spacing-md) var(--av-spacing-lg);
    }

    .section-title {
      font-size: var(--av-font-size-base);
      font-weight: 600;
      color: var(--av-color-primary);
      margin-bottom: var(--av-spacing-md);
      padding-bottom: var(--av-spacing-xs);
      border-bottom: 2px solid var(--av-color-primary-light);
    }

    .form-group {
      margin-bottom: var(--av-spacing-md);
    }

    .form-label {
      font-weight: 600;
      color: var(--av-color-gray-900);
      margin-bottom: var(--av-spacing-xs);
      display: block;
      font-size: var(--av-font-size-sm);
    }

    .form-control, .form-select {
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-spacing-xs);
      padding: var(--av-spacing-sm) var(--av-spacing-md);
      font-size: var(--av-font-size-sm);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      background-color: white;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--av-color-primary);
      box-shadow: 0 0 0 2px rgba(0, 89, 179, 0.25);
      outline: none;
    }

    .radio-group {
      display: flex;
      gap: var(--av-spacing-sm);
      margin-top: var(--av-spacing-xs);
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: var(--av-spacing-xs);
      flex: 1;
      padding: var(--av-spacing-sm);
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-spacing-xs);
      transition: border-color 0.2s ease;
      font-size: var(--av-font-size-sm);
      background-color: white;
    }

    .radio-option:hover {
      border-color: var(--av-color-primary);
    }

    .radio-option input[type="radio"]:checked + label {
      color: var(--av-color-primary);
    }

    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: var(--av-color-primary);
      flex-shrink: 0;
    }

    .radio-option label {
      margin-bottom: 0;
      font-weight: 500;
      cursor: pointer;
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: var(--av-spacing-xs);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: var(--av-spacing-sm);
      margin-top: var(--av-spacing-xs);
    }

    .checkbox-container input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--av-color-primary);
      flex-shrink: 0;
    }

    .checkbox-container label {
      margin-bottom: 0;
      font-weight: 500;
      color: var(--av-color-gray-900);
      cursor: pointer;
      font-size: var(--av-font-size-sm);
      display: flex;
      align-items: center;
      gap: var(--av-spacing-xs);
    }

    .verify-section {
      background: var(--av-color-gray-50);
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-border-radius);
      padding: var(--av-spacing-md);
      margin: var(--av-spacing-sm) 0;
    }

    .verify-info {
      margin-top: var(--av-spacing-sm);
      padding: var(--av-spacing-sm);
      background: white;
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-spacing-xs);
      font-size: var(--av-font-size-sm);
      color: var(--av-color-gray-600);
      line-height: 1.4;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--av-color-primary);
      color: white;
      border-radius: 50%;
      font-size: 10px;
      cursor: help;
      font-weight: bold;
      position: relative;
      flex-shrink: 0;
    }

    .tooltip-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: var(--av-spacing-sm) var(--av-spacing-md);
      border-radius: var(--av-spacing-xs);
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 300px;
      white-space: normal;
      width: max-content;
      text-align: left;
      font-weight: normal;
      line-height: 1.3;
    }

    .tooltip-icon:hover::before {
      content: '';
      position: absolute;
      bottom: 115%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #333;
      z-index: 1000;
    }

    .products-section {
      background: var(--av-color-gray-50);
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-border-radius);
      padding: var(--av-spacing-md);
      margin: var(--av-spacing-md) 0;
    }

    .products-table {
      background: white;
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-spacing-xs);
      overflow: hidden;
    }

    .products-table thead th {
      background: var(--av-color-primary-light);
      font-weight: 600;
      color: var(--av-color-primary);
      padding: var(--av-spacing-sm);
      border: none;
      font-size: var(--av-font-size-sm);
      text-align: left;
    }

    .products-table tbody td {
      padding: var(--av-spacing-sm);
      border-bottom: 1px solid var(--av-color-gray-200);
      vertical-align: middle;
    }

    .products-table tbody tr:last-child td {
      border-bottom: none;
    }

    .product-row input, .product-row select {
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-spacing-xs);
      padding: var(--av-spacing-sm);
      font-size: var(--av-font-size-sm);
      width: 100%;
    }

    .product-row input:focus, .product-row select:focus {
      border-color: var(--av-color-primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 89, 179, 0.25);
    }

    .btn-add-product {
      background: var(--av-color-success);
      border: none;
      color: white;
      padding: var(--av-spacing-xs) var(--av-spacing-sm);
      border-radius: var(--av-spacing-xs);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
      white-space: nowrap;
    }

    .btn-add-product:hover {
      background: #16a34a;
    }

    .btn-remove {
      background: var(--av-color-danger);
      border: none;
      color: white;
      padding: var(--av-spacing-xs);
      border-radius: var(--av-spacing-xs);
      font-size: 0.7rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
    }

    .btn-remove:hover {
      background: #dc2626;
    }

    .btn-remove:disabled {
      background: var(--av-color-gray-600);
      cursor: not-allowed;
    }

    .summary-section {
      background: var(--av-color-gray-50);
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-border-radius);
      padding: var(--av-spacing-md);
      margin: var(--av-spacing-md) 0;
    }

    .summary-content {
      display: flex;
      align-items: center;
      gap: var(--av-spacing-md);
      flex-wrap: wrap;
    }

    .summary-title {
      font-size: var(--av-font-size-base);
      font-weight: 600;
      color: var(--av-color-primary);
    }

    .summary-item-compact {
      display: flex;
      align-items: center;
      gap: var(--av-spacing-xs);
    }

    .summary-label {
      font-size: var(--av-font-size-sm);
      color: var(--av-color-gray-600);
      font-weight: 400;
    }

    .summary-value {
      font-size: var(--av-font-size-sm);
      font-weight: 600;
      color: var(--av-color-primary);
    }

    .calculate-btn {
      background: var(--av-color-primary);
      border: none;
      color: white;
      padding: var(--av-spacing-md) var(--av-spacing-lg);
      border-radius: var(--av-border-radius);
      font-size: var(--av-font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 100%;
      margin-top: var(--av-spacing-md);
    }

    .calculate-btn:hover {
      background: #004594;
    }

    .calculate-btn:disabled {
      background: var(--av-color-gray-600);
      cursor: not-allowed;
    }

    .results-section {
      margin-top: var(--av-spacing-md);
      padding: var(--av-spacing-md);
      background: white;
      border: 1px solid var(--av-color-gray-200);
      border-radius: var(--av-border-radius);
    }

    .results-table {
      font-size: var(--av-font-size-sm);
    }

    .results-table thead th {
      background: var(--av-color-primary-light);
      font-weight: 600;
      color: var(--av-color-primary);
      padding: var(--av-spacing-sm);
      border: none;
    }

    .results-table tbody td {
      padding: var(--av-spacing-sm);
      border-bottom: 1px solid var(--av-color-gray-200);
    }

    .total-duty-highlight {
      background: var(--av-color-success);
      color: white;
      padding: var(--av-spacing-md);
      border-radius: var(--av-border-radius);
      text-align: center;
      margin-top: var(--av-spacing-md);
    }

    .total-duty-highlight h4 {
      margin: 0 0 var(--av-spacing-xs) 0;
      font-weight: 600;
      font-size: var(--av-font-size-base);
    }

    .total-duty-highlight .amount {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .description-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
      padding: var(--av-spacing-xs) var(--av-spacing-sm);
      border-radius: var(--av-spacing-xs);
      font-size: 0.7rem;
      margin-top: var(--av-spacing-xs);
      display: none;
      font-weight: 500;
      line-height: 1.2;
    }

    .description-warning.show {
      display: block;
    }

    @media (max-width: 768px) {
      .radio-group {
        flex-direction: column;
        gap: var(--av-spacing-sm);
      }

      .summary-content {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--av-spacing-sm);
      }

      .products-table {
        font-size: 0.75rem;
      }

      .products-table thead th,
      .products-table tbody td {
        padding: var(--av-spacing-xs);
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="calculator-card">
    <div class="header-section">
      <h1>US Postal Duty Calculator</h1>
      <p>Calculate customs duties and fees for your international shipments</p>
    </div>

    <div class="form-section">
      <form id="duty-form">
        <!-- MAIN CONTROLS ROW -->
        <div class="row">
          <div class="col-md-2">
            <div class="form-group">
              <label for="entry_date" class="form-label">Ship Date *</label>
              <input type="date" class="form-control" id="entry_date" name="entry_date" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="destination_country" class="form-label">Destination *</label>
              <select class="form-select" id="destination_country" name="destination_country">
                <option value="US" selected>ðŸ‡ºðŸ‡¸ United States</option>
                <option value="CA">ðŸ‡¨ðŸ‡¦ Canada</option>
                <option value="MX">ðŸ‡²ðŸ‡½ Mexico</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label for="calculation_currency" class="form-label">Currency *</label>
              <select class="form-select" id="calculation_currency" name="calculation_currency" onchange="updateAllCurrencyDisplays()">
                <option value="USD" selected>USD</option>
                <option value="EUR">EUR</option>
                <option value="CNY">CNY</option>
                <option value="JPY">JPY</option>
                <option value="GBP">GBP</option>
                <option value="CAD">CAD</option>
                <option value="AUD">AUD</option>
                <option value="KRW">KRW</option>
                <option value="INR">INR</option>
                <option value="MXN">MXN</option>
                <option value="BRL">BRL</option>
                <option value="VND">VND</option>
                <option value="THB">THB</option>
                <option value="MYR">MYR</option>
                <option value="SGD">SGD</option>
                <option value="PHP">PHP</option>
                <option value="IDR">IDR</option>
                <option value="TWD">TWD</option>
                <option value="HKD">HKD</option>
                <option value="CHF">CHF</option>
                <option value="SEK">SEK</option>
                <option value="NOK">NOK</option>
                <option value="DKK">DKK</option>
                <option value="PLN">PLN</option>
              </select>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <label class="form-label">Method *</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="method_ad_valorem" name="method" value="ad_valorem" checked>
                  <label for="method_ad_valorem">
                    Ad Valorem
                    <span class="tooltip-icon" data-tooltip="Duty calculated per COO bucket: declared value Ã— effective IEEPA rate, then summed across all COO buckets in the package">i</span>
                  </label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="method_specific" name="method" value="specific">
                  <label for="method_specific">
                    Specific
                    <span class="tooltip-icon" data-tooltip="Duty based on highest IEEPA rate in package: <16% = $80, 16-25% = $160, >25% = $200 per package">i</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- COMPACT VERIFICATION SECTION -->
        <div class="verify-section">
          <div class="checkbox-container">
            <input type="checkbox" id="verify_description" name="verify_description">
            <label for="verify_description">
              Verify description
              <span class="tooltip-icon" data-tooltip="When enabled, the system will validate that product descriptions are detailed enough for accurate tariff classification. If a description is insufficient, you'll be prompted to improve it.">i</span>
            </label>
          </div>
          <div class="verify-info">
            When verification is enabled, descriptions that are too vague for accurate classification will be flagged, allowing you to improve them before calculation.
          </div>
        </div>

        <div class="products-section">
          <h3 class="section-title">Product Information</h3>

          <div class="table-responsive">
            <table class="table products-table">
              <thead>
                <tr>
                  <th style="width: 25%;">Description</th>
                  <th style="width: 15%;">Tariff Code</th>
                  <th style="width: 18%;">Country of Origin</th>
                  <th style="width: 10%;">Quantity</th>
                  <th style="width: 12%;">Item Value</th>
                  <th style="width: 12%;">Line Value</th>
                  <th style="width: 8%;">
                    <button type="button" class="btn-add-product" onclick="addRow()">Add</button>
                  </th>
                </tr>
              </thead>
              <tbody id="products-body"></tbody>
            </table>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-content">
            <span class="summary-title">Shipment Summary:</span>
            <span class="summary-item-compact">
              <span class="summary-label">Total Value:</span>
              <span class="summary-value" id="total_value_display">$0.00 (USD)</span>
            </span>
            <span class="summary-item-compact">
              <span class="summary-label">Items:</span>
              <span class="summary-value" id="total_items_display">0</span>
            </span>
          </div>
          <input type="hidden" id="total_value" name="total_value">
        </div>

        <button type="submit" class="calculate-btn">Calculate Customs & Duties</button>
      </form>
    </div>
  </div>

  <div id="results"></div>
  <div id="debug" style="margin-top: 1rem;"></div>
</div>

<script>
// Country data (removed currency field since it's now global)
const COUNTRIES = [
  { code: "CN", name: "China", flag: "ðŸ‡¨ðŸ‡³" },
  { code: "US", name: "United States", flag: "ðŸ‡ºðŸ‡¸" },
  { code: "DE", name: "Germany", flag: "ðŸ‡©ðŸ‡ª" },
  { code: "JP", name: "Japan", flag: "ðŸ‡¯ðŸ‡µ" },
  { code: "GB", name: "United Kingdom", flag: "ðŸ‡¬ðŸ‡§" },
  { code: "FR", name: "France", flag: "ðŸ‡«ðŸ‡·" },
  { code: "IT", name: "Italy", flag: "ðŸ‡®ðŸ‡¹" },
  { code: "CA", name: "Canada", flag: "ðŸ‡¨ðŸ‡¦" },
  { code: "AU", name: "Australia", flag: "ðŸ‡¦ðŸ‡º" },
  { code: "KR", name: "South Korea", flag: "ðŸ‡°ðŸ‡·" },
  { code: "IN", name: "India", flag: "ðŸ‡®ðŸ‡³" },
  { code: "MX", name: "Mexico", flag: "ðŸ‡²ðŸ‡½" },
  { code: "BR", name: "Brazil", flag: "ðŸ‡§ðŸ‡·" },
  { code: "VN", name: "Vietnam", flag: "ðŸ‡»ðŸ‡³" },
  { code: "TH", name: "Thailand", flag: "ðŸ‡¹ðŸ‡­" },
  { code: "MY", name: "Malaysia", flag: "ðŸ‡²ðŸ‡¾" },
  { code: "SG", name: "Singapore", flag: "ðŸ‡¸ðŸ‡¬" },
  { code: "PH", name: "Philippines", flag: "ðŸ‡µðŸ‡­" },
  { code: "ID", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©" },
  { code: "TW", name: "Taiwan", flag: "ðŸ‡¹ðŸ‡¼" },
  { code: "HK", name: "Hong Kong", flag: "ðŸ‡­ðŸ‡°" },
  { code: "CH", name: "Switzerland", flag: "ðŸ‡¨ðŸ‡­" },
  { code: "SE", name: "Sweden", flag: "ðŸ‡¸ðŸ‡ª" },
  { code: "NO", name: "Norway", flag: "ðŸ‡³ðŸ‡´" },
  { code: "DK", name: "Denmark", flag: "ðŸ‡©ðŸ‡°" },
  { code: "PL", name: "Poland", flag: "ðŸ‡µðŸ‡±" },
  { code: "ES", name: "Spain", flag: "ðŸ‡ªðŸ‡¸" },
  { code: "NL", name: "Netherlands", flag: "ðŸ‡³ðŸ‡±" },
  { code: "BE", name: "Belgium", flag: "ðŸ‡§ðŸ‡ª" },
  { code: "AT", name: "Austria", flag: "ðŸ‡¦ðŸ‡¹" }
];

// Currency data with symbols
const CURRENCIES = [
  { code: "USD", symbol: "$", name: "US Dollar" },
  { code: "EUR", symbol: "â‚¬", name: "Euro" },
  { code: "CNY", symbol: "Â¥", name: "Chinese Yuan" },
  { code: "JPY", symbol: "Â¥", name: "Japanese Yen" },
  { code: "GBP", symbol: "Â£", name: "British Pound" },
  { code: "CAD", symbol: "C$", name: "Canadian Dollar" },
  { code: "AUD", symbol: "A$", name: "Australian Dollar" },
  { code: "KRW", symbol: "â‚©", name: "South Korean Won" },
  { code: "INR", symbol: "â‚¹", name: "Indian Rupee" },
  { code: "MXN", symbol: "Mex$", name: "Mexican Peso" },
  { code: "BRL", symbol: "R$", name: "Brazilian Real" },
  { code: "VND", symbol: "â‚«", name: "Vietnamese Dong" },
  { code: "THB", symbol: "à¸¿", name: "Thai Baht" },
  { code: "MYR", symbol: "RM", name: "Malaysian Ringgit" },
  { code: "SGD", symbol: "S$", name: "Singapore Dollar" },
  { code: "PHP", symbol: "â‚±", name: "Philippine Peso" },
  { code: "IDR", symbol: "Rp", name: "Indonesian Rupiah" },
  { code: "TWD", symbol: "NT$", name: "Taiwan Dollar" },
  { code: "HKD", symbol: "HK$", name: "Hong Kong Dollar" },
  { code: "CHF", symbol: "Fr", name: "Swiss Franc" },
  { code: "SEK", symbol: "kr", name: "Swedish Krona" },
  { code: "NOK", symbol: "kr", name: "Norwegian Krone" },
  { code: "DKK", symbol: "kr", name: "Danish Krone" },
  { code: "PLN", symbol: "zÅ‚", name: "Polish Zloty" }
];

// Static exchange rates to USD
const EXCHANGE_RATES = {
  USD: 1.00, EUR: 0.85, CNY: 7.25, JPY: 149.50, GBP: 0.73,
  CAD: 1.37, AUD: 1.52, KRW: 1320.00, INR: 83.20, MXN: 17.25,
  BRL: 5.05, VND: 24500.00, THB: 35.80, MYR: 4.65, SGD: 1.35,
  PHP: 56.20, IDR: 15750.00, TWD: 31.50, HKD: 7.82, CHF: 0.88,
  SEK: 10.85, NOK: 10.75, DKK: 6.85, PLN: 4.05
};

// Convert currency
function convertCurrency(amount, from, to = 'USD') {
  if (from === to) return amount;
  const fromRate = EXCHANGE_RATES[from] || 1;
  const toRate = EXCHANGE_RATES[to] || 1;
  return (amount / fromRate) * toRate;
}

// Get currency symbol
function getCurrencySymbol(code) {
  const currency = CURRENCIES.find(c => c.code === code);
  return currency ? currency.symbol : code;
}

// Get selected calculation currency
function getCalculationCurrency() {
  return document.getElementById('calculation_currency').value;
}

// Update all currency displays when global currency changes
function updateAllCurrencyDisplays() {
  updateTotals();
  // Update all placeholder text in value fields
  const valueInputs = document.querySelectorAll('input[name="per_unit_value"]');
  const currency = getCalculationCurrency();

  valueInputs.forEach(input => {
    if (!input.value || input.value === '0.00') {
      input.placeholder = `0.00 ${currency}`;
    }
  });
}

// Set today's date and add initial row
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('entry_date').value = today;
  addRow();
});

function addRow() {
  const table = document.getElementById("products-body");
  const row = document.createElement("tr");
  row.className = "product-row";

  const countryOptions = COUNTRIES.map(c =>
    `<option value="${c.code}" ${c.code === "CN" ? "selected" : ""}>${c.flag} ${c.name}</option>`
  ).join("");

  const currency = getCalculationCurrency();

  row.innerHTML = `
    <td>
      <input name="description" class="form-control" placeholder="e.g., Men's cotton shirt" onblur="fetchHSCode(this)" required>
      <div class="description-warning"></div>
    </td>
    <td><input name="hs_code" class="form-control" placeholder="Auto-filled" oninput="onHSCodeManualEntry(this)"></td>
    <td><select name="coo" class="form-select">${countryOptions}</select></td>
    <td><input name="quantity" type="number" value="1" class="form-control" min="1" required onchange="updateLineValue(this)"></td>
    <td><input name="per_unit_value" type="number" step="0.01" class="form-control" value="0.00" placeholder="0.00 ${currency}" required onchange="updateLineValue(this)"></td>
    <td><input name="line_value" type="text" class="form-control" readonly value="0.00 ${currency}" style="background-color: var(--av-color-gray-50);"></td>
    <td><button type="button" class="btn-remove" onclick="removeRow(this)">Ã—</button></td>
  `;

  table.appendChild(row);
  updateTotals();
  updateRemoveButtons();
}

function removeRow(button) {
  button.closest('tr').remove();
  updateTotals();
  updateRemoveButtons();
}

function updateRemoveButtons() {
  const rows = document.querySelectorAll("#products-body tr");
  const removeButtons = document.querySelectorAll(".btn-remove");
  removeButtons.forEach(button => {
    if (rows.length <= 1) {
      button.disabled = true;
      button.style.opacity = '0.5';
    } else {
      button.disabled = false;
      button.style.opacity = '1';
    }
  });
}

function updateLineValue(input) {
  const row = input.closest("tr");
  const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
  const perUnitValue = parseFloat(row.querySelector('input[name="per_unit_value"]').value) || 0;
  const lineValueInput = row.querySelector('input[name="line_value"]');
  const currency = getCalculationCurrency();
  const lineValue = quantity * perUnitValue;

  lineValueInput.value = `${lineValue.toFixed(2)} ${currency}`;
  updateTotals();
}

function updateTotals() {
  const rows = document.querySelectorAll("#products-body tr");
  let totalValue = 0;
  let totalItems = 0;
  const currency = getCalculationCurrency();
  const symbol = getCurrencySymbol(currency);

  Array.from(rows).forEach(row => {
    const lineValueText = row.querySelector('input[name="line_value"]').value || '0.00';
    const lineValue = parseFloat(lineValueText.replace(/[^\d.-]/g, '')) || 0;
    const quantity = parseFloat(row.querySelector('input[name="quantity"]').value || 0);

    totalValue += lineValue;
    totalItems += quantity;
  });

  document.getElementById("total_value_display").textContent = `${symbol}${totalValue.toFixed(2)} (${currency})`;
  document.getElementById("total_items_display").textContent = totalItems.toString();

  // Store total value in USD for backend processing
  const totalValueUSD = convertCurrency(totalValue, currency, 'USD');
  document.getElementById("total_value").value = totalValueUSD.toFixed(2);
}

async function fetchHSCode(input) {
  const row = input.closest("tr");
  const desc = input.value;
  const coo = row.querySelector('select[name="coo"]').value;
  const hsField = row.querySelector('input[name="hs_code"]');
  const warningDiv = row.querySelector('.description-warning');
  const verifyEnabled = document.getElementById('verify_description').checked;

  if (!desc || !hsField) return;

  warningDiv.classList.remove('show');
  warningDiv.textContent = '';
  hsField.placeholder = "Loading...";
  hsField.style.backgroundColor = "var(--av-color-gray-50)";

  try {
    const response = await fetch("/fetch_hs_code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        description: desc,
        coo: coo,
        verify_description: verifyEnabled
      })
    });

    const json = await response.json();

    if (json.hs_code) {
      hsField.value = json.hs_code;
      hsField.style.backgroundColor = "#d1fae5";
      hsField.setAttribute('readonly', true);
    } else if (json.verification_failed && verifyEnabled) {
      hsField.value = '';
      hsField.removeAttribute('readonly');
      hsField.placeholder = "Enter HS code manually";
      hsField.style.backgroundColor = "#fef3c7";
      warningDiv.textContent = "âš ï¸ Description needs more details. Enter HS code manually or improve description.";
      warningDiv.classList.add('show');
      setTimeout(() => hsField.focus(), 100);
    } else {
      hsField.placeholder = "Not found";
      hsField.style.backgroundColor = "#fee2e2";
    }
  } catch (err) {
    hsField.placeholder = "Error";
    hsField.style.backgroundColor = "#fee2e2";
  }
}

function onHSCodeManualEntry(input) {
  const row = input.closest("tr");
  const warningDiv = row.querySelector('.description-warning');

  if (input.value.trim()) {
    input.style.backgroundColor = "#dbeafe";
    warningDiv.classList.remove('show');
    warningDiv.textContent = '';
  }
}

document.getElementById("duty-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const verifyEnabled = document.getElementById('verify_description').checked;
  const rows = document.querySelectorAll("#products-body tr");
  let hasInsufficientDescriptions = false;

  if (verifyEnabled) {
    Array.from(rows).forEach(row => {
      const hsCode = row.querySelector('input[name="hs_code"]').value;
      if (!hsCode) {
        hasInsufficientDescriptions = true;
      }
    });

    if (hasInsufficientDescriptions) {
      alert('Please improve product descriptions that are flagged as insufficient before calculating duties.');
      return;
    }
  }

  const totalValueUSD = parseFloat(document.getElementById("total_value").value);
  if (totalValueUSD > 2500) {
    alert('Total shipment value exceeds $2,500 USD. Postal method not available.');
    return;
  }

  const submitBtn = document.querySelector('.calculate-btn');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Calculating...';
  submitBtn.disabled = true;

  const entry_date = document.getElementById("entry_date").value;
  const method = document.querySelector('input[name="method"]:checked').value;
  const destination_country = document.getElementById("destination_country").value;
  const calculation_currency = getCalculationCurrency();

  const products = Array.from(rows).map((row, index) => {
    const description = row.querySelector('input[name="description"]').value;
    const hs_code = row.querySelector('input[name="hs_code"]').value;
    const coo = row.querySelector('select[name="coo"]').value;
    const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
    const per_unit_value = parseFloat(row.querySelector('input[name="per_unit_value"]').value);
    const lineValueText = row.querySelector('input[name="line_value"]').value;
    const line_value = parseFloat(lineValueText.replace(/[^\d.-]/g, '')) || 0;

    // Convert to USD for backend processing
    const per_unit_value_usd = convertCurrency(per_unit_value, calculation_currency, 'USD');
    const line_value_usd = convertCurrency(line_value, calculation_currency, 'USD');

    return {
      description: description,
      hs_code: hs_code,
      coo: coo,
      currency: calculation_currency,
      quantity: quantity,
      per_unit_value: per_unit_value_usd,
      line_value: line_value_usd,
      original_per_unit_value: per_unit_value,
      original_line_value: line_value,
      exchange_rate: EXCHANGE_RATES[calculation_currency]
    };
  });

  const payload = {
    entry_date,
    method,
    destination_country,
    calculation_currency,
    products,
    total_value: totalValueUSD,
    verify_description: verifyEnabled,
    exchange_rates: EXCHANGE_RATES
  };

  try {
    const res = await fetch("/calculate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    displayResults(json);
  } catch (error) {
    document.getElementById("results").innerHTML = `<div class="alert alert-danger">Calculation failed: ${error.message}</div>`;
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

function displayResults(json) {
  const resultsContainer = document.getElementById("results");
  const debugContainer = document.getElementById("debug");
  const calculation_currency = getCalculationCurrency();
  const currencySymbol = getCurrencySymbol(calculation_currency);

  if (json.error) {
    resultsContainer.innerHTML = `
      <div class="results-section">
        <div class="alert alert-danger">
          <strong>Calculation Error:</strong> ${json.error}
        </div>
      </div>`;
    debugContainer.innerHTML = json.debug ? `<pre style="background: var(--av-color-gray-50); padding: 1rem; border-radius: 4px; font-size: 0.85rem;">${json.debug}</pre>` : "";
    return;
  }

  // Convert duty amounts to selected currency
  const convertedResults = json.results.map(r => ({
    ...r,
    duty_in_selected_currency: convertCurrency(r.duty, 'USD', calculation_currency)
  }));

  const total_duty_in_selected_currency = convertCurrency(json.total_duty, 'USD', calculation_currency);

  resultsContainer.innerHTML = `
    <div class="results-section">
      <h3 class="section-title">Calculation Results</h3>

      <div class="table-responsive">
        <table class="table results-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Tariff Code</th>
              <th>COO</th>
              <th>Qty</th>
              <th>Unit Value</th>
              <th>Line Value</th>
              <th>Total Rate</th>
              <th>Total Duty</th>
            </tr>
          </thead>
          <tbody>
            ${convertedResults.map(r => `
              <tr>
                <td>${r.description}</td>
                <td>${r.hs_code}</td>
                <td>${r.coo}</td>
                <td>${r.quantity}</td>
                <td>${currencySymbol}${(r.original_per_unit_value || r.per_unit_value).toFixed(2)}</td>
                <td>${currencySymbol}${(r.original_line_value || r.line_value).toFixed(2)}</td>
                <td>${r.total_rate}%</td>
                <td>${currencySymbol}${r.duty_in_selected_currency.toFixed(2)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div style="background: var(--av-color-gray-50); padding: 1rem; border-radius: 4px; border: 1px solid var(--av-color-gray-200);">
            <p><strong>Method:</strong> ${json.logic_applied}</p>
            <p><strong>Currency:</strong> ${calculation_currency}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="total-duty-highlight">
            <h4>Total Customs Duty</h4>
            <div class="amount">${currencySymbol}${total_duty_in_selected_currency.toFixed(2)}</div>
            <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">${calculation_currency}</div>
          </div>
        </div>
      </div>

      ${json.savings_recommendation ? `
        <div class="row mt-3">
          <div class="col-12">
            <div style="background: #ecfdf5; border: 2px solid #a7f3d0; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--av-color-primary);">
              <div class="d-flex align-items-center mb-2">
                <div style="background: var(--av-color-primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-right: 8px;">ðŸ’¡</div>
                <h6 style="margin: 0; color: var(--av-color-primary); font-weight: 600;">Money-Saving Opportunity!</h6>
              </div>
              <div class="row">
                <div class="col-md-8">
                  <p style="margin: 0 0 0.25rem 0; color: var(--av-color-gray-900); line-height: 1.4; font-size: 0.85rem;">
                    <strong>Alternative Method:</strong> ${json.savings_recommendation.method}
                  </p>
                  <p style="margin: 0; color: var(--av-color-gray-600); font-size: 0.8rem; line-height: 1.3;">
                    ${json.savings_recommendation.reason}
                  </p>
                </div>
                <div class="col-md-4 text-end">
                  <div style="background: var(--av-color-success); color: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                    <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.2rem;">You could save</div>
                    <div style="font-size: 1.2rem; font-weight: 700;">${currencySymbol}${convertCurrency(json.savings_recommendation.savings, 'USD', calculation_currency).toFixed(2)}</div>
                    <div style="font-size: 0.7rem; opacity: 0.9; margin-top: 0.2rem;">Alt: ${currencySymbol}${convertCurrency(json.savings_recommendation.alternative_duty, 'USD', calculation_currency).toFixed(2)}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      ` : ''}
    </div>
  `;

  debugContainer.innerHTML = json.debug ?
    `<details style="background: var(--av-color-gray-50); padding: 0.75rem; border-radius: 4px; margin-top: 0.75rem; border: 1px solid var(--av-color-gray-200);">
      <summary style="cursor: pointer; font-weight: 600; color: var(--av-color-primary); font-size: 0.85rem;">Debug Information</summary>
      <pre style="margin-top: 0.75rem; font-size: 0.75rem; white-space: pre-wrap;">${json.debug}</pre>
    </details>` : "";
}
</script>

</body>
</html>