<!DOCTYPE html>
<html>
<head>
  <title>US Postal Duty Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #ffffff;
      font-family: 'Apertura', 'Avenir Next Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #56646A;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .calculator-card {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .header-section {
      background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%);
      color: white;
      padding: 2rem;
      position: relative;
    }

    .header-section::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="80" cy="20" r="40" fill="rgba(255,255,255,0.1)"/></svg>') no-repeat;
      background-size: contain;
    }

    .header-section h1 {
      font-size: 1.875rem;
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
      position: relative;
      z-index: 1;
    }

    .header-section p {
      margin: 0.75rem 0 0 0;
      opacity: 0.95;
      font-weight: 400;
      font-size: 1rem;
      position: relative;
      z-index: 1;
    }

    .form-section {
      padding: 2rem;
      background: #FAFBFC;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #004459;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      font-weight: 600;
      color: #004459;
      margin-bottom: 0.5rem;
      display: block;
      font-size: 0.875rem;
    }

    .form-control, .form-select {
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      padding: 0.875rem 1rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      background-color: white;
      color: #374151;
    }

    .form-control:focus, .form-select:focus {
      border-color: #FF6600;
      box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
      outline: none;
    }

    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      padding: 1rem 1.25rem;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      background-color: white;
      cursor: pointer;
    }

    .radio-option:hover {
      border-color: #FF6600;
      background-color: rgba(255, 102, 0, 0.02);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(255, 102, 0, 0.1);
    }

    .radio-option input[type="radio"]:checked + label {
      color: #FF6600;
      font-weight: 600;
    }

    .radio-option:has(input[type="radio"]:checked) {
      border-color: #FF6600;
      background-color: rgba(255, 102, 0, 0.05);
    }

    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: #FF6600;
    }

    .radio-option label {
      margin-bottom: 0;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      color: #374151;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
      padding: 1rem;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .checkbox-container:hover {
      border-color: #FF6600;
      background-color: rgba(255, 102, 0, 0.02);
    }

    .checkbox-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #FF6600;
    }

    .checkbox-container label {
      margin-bottom: 0;
      font-weight: 500;
      color: #004459;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .verify-section {
      background: linear-gradient(135deg, rgba(255, 102, 0, 0.02) 0%, rgba(250, 251, 252, 1) 100%);
      border: 2px solid #E5E7EB;
      border-left: 6px solid #FF6600;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .verify-info {
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 0.875rem;
      color: #6B7280;
      line-height: 1.5;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%);
      color: white;
      border-radius: 50%;
      font-size: 11px;
      cursor: help;
      font-weight: bold;
      position: relative;
      box-shadow: 0 2px 4px rgba(255, 102, 0, 0.2);
    }

    .tooltip-icon:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 130%;
      left: 50%;
      transform: translateX(-50%);
      background: #004459;
      color: white;
      padding: 0.875rem 1.125rem;
      border-radius: 8px;
      font-size: 12px;
      white-space: normal;
      z-index: 1000;
      box-shadow: 0 4px 16px rgba(0, 68, 89, 0.25);
      max-width: 320px;
      width: max-content;
      text-align: left;
      font-weight: normal;
      line-height: 1.4;
    }

    .tooltip-icon:hover::before {
      content: '';
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #004459;
      z-index: 1000;
    }

    .products-section {
      padding: 2rem;
      margin: 1.5rem 0;
      background: white;
      border-radius: 12px;
      border: 1px solid #E5E7EB;
    }

    .products-table {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .products-table thead th {
      background: #F9FAFB;
      font-weight: 600;
      color: #374151;
      padding: 1.25rem 1rem;
      border: none;
      font-size: 0.875rem;
      text-align: left;
      border-bottom: 2px solid #E5E7EB;
    }

    .products-table tbody td {
      padding: 1rem 0.875rem;
      border-bottom: 1px solid #F3F4F6;
      vertical-align: middle;
      background: white;
    }

    .products-table tbody tr:hover {
      background-color: rgba(255, 102, 0, 0.02);
    }

    .product-row input, .product-row select {
      border: 2px solid #E5E7EB;
      border-radius: 6px;
      padding: 0.625rem 0.875rem;
      font-size: 0.875rem;
      width: 100%;
      transition: all 0.2s ease;
    }

    .product-row input:focus, .product-row select:focus {
      border-color: #FF6600;
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.1);
    }

    .btn-add-product {
      background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%);
      border: none;
      color: white;
      padding: 0.625rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      box-shadow: 0 2px 6px rgba(255, 102, 0, 0.25);
    }

    .btn-add-product:hover {
      background: linear-gradient(135deg, #FF8533 0%, #FF6600 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 102, 0, 0.35);
    }

    .btn-remove {
      background: #EF4444;
      border: none;
      color: white;
      padding: 0.375rem 0.625rem;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      background: #DC2626;
      transform: translateY(-1px);
    }

    .btn-remove:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
    }

    .summary-section {
      background: linear-gradient(135deg, #FAFBFC 0%, #F3F4F6 100%);
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .summary-content {
      display: flex;
      align-items: center;
      gap: 2.5rem;
      flex-wrap: wrap;
    }

    .summary-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #004459;
    }

    .summary-item-compact {
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .summary-label {
      font-size: 0.875rem;
      color: #6B7280;
      font-weight: 500;
    }

    .summary-value {
      font-size: 0.875rem;
      font-weight: 700;
      color: #FF6600;
    }

    .calculate-btn {
      background: linear-gradient(135deg, #004459 0%, #056BA6 100%);
      border: none;
      color: white;
      padding: 1.25rem 2.5rem;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 2rem;
      box-shadow: 0 4px 16px rgba(0, 68, 89, 0.25);
      position: relative;
      overflow: hidden;
    }

    .calculate-btn:hover {
      background: linear-gradient(135deg, #056BA6 0%, #004459 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0, 68, 89, 0.35);
    }

    .calculate-btn:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .results-section {
      margin-top: 2rem;
      padding: 2rem;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .results-table {
      font-size: 0.875rem;
    }

    .results-table thead th {
      background: #F9FAFB;
      font-weight: 600;
      color: #374151;
      padding: 1.25rem 1rem;
      border: none;
      border-bottom: 2px solid #E5E7EB;
    }

    .results-table tbody td {
      padding: 1rem 0.875rem;
      border-bottom: 1px solid #F3F4F6;
    }

    .description-warning {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border: 2px solid #F59E0B;
      color: #92400E;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.8rem;
      margin-top: 0.75rem;
      display: none;
      font-weight: 500;
      line-height: 1.4;
    }

    .description-warning.show {
      display: block;
    }

    .avalara-footer {
      color: #6B7280;
      text-align: center;
      padding: 2rem 0;
      font-size: 0.875rem;
      margin-top: 3rem;
      font-weight: 500;
      border-top: 1px solid #E5E7EB;
    }

    /* Duty Rate Calculation Breakdown Styles */
    .duty-breakdown-section {
      margin-top: 2rem;
      padding: 2rem;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .duty-breakdown-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #004459;
      margin-bottom: 2rem;
      text-align: center;
    }

    .product-breakdown {
      background: #e6f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 8px;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .product-breakdown-header {
      background: #cce7ff;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #b3d9ff;
      font-weight: 600;
      color: #0066cc;
    }

    .breakdown-table {
      width: 100%;
      margin: 0;
      background: white;
    }

    .breakdown-table th {
      background: #f8f9fa;
      padding: 0.75rem 1rem;
      font-weight: 600;
      color: #495057;
      border: 1px solid #dee2e6;
      text-align: left;
    }

    .breakdown-table td {
      padding: 0.75rem 1rem;
      border: 1px solid #dee2e6;
      vertical-align: middle;
    }

    .hs-code-link {
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }

    .rate-cell {
      text-align: right;
      font-weight: 600;
      color: #dc3545;
    }

    .breakdown-summary {
      padding: 1.5rem;
      background: #f8f9fa;
      border-top: 1px solid #dee2e6;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }

    .summary-row:last-child {
      margin-bottom: 0;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .summary-label {
      color: #495057;
    }

    .summary-amount {
      font-weight: 600;
    }

    .total-rate {
      color: #0066cc;
      font-size: 1.2rem;
    }

    .duty-amount {
      color: #28a745;
      font-size: 1.2rem;
    }

    @media (max-width: 768px) {
      .radio-group {
        flex-direction: column;
        gap: 1rem;
      }

      .summary-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.25rem;
      }

      .products-table {
        font-size: 0.8rem;
      }

      .products-table thead th,
      .products-table tbody td {
        padding: 0.75rem 0.5rem;
      }

      .header-section {
        padding: 1.5rem;
      }

      .form-section {
        padding: 1.5rem;
      }

      .products-section {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="calculator-card">
    <div class="header-section">
      <h1>US Postal Duty Calculator</h1>
      <p>Calculate customs duties and fees for your international shipments</p>
    </div>

    <div class="form-section">
      <form id="duty-form">
        <!-- MAIN CONTROLS ROW -->
        <div class="row">
          <div class="col-md-2">
            <div class="form-group">
              <label for="entry_date" class="form-label">Ship Date *</label>
              <input type="date" class="form-control" id="entry_date" name="entry_date" required>
            </div>
          </div>
          <div class="col-md-3">
            <div class="form-group">
              <label for="destination_country" class="form-label">Destination *</label>
              <select class="form-select" id="destination_country" name="destination_country">
                <option value="US" selected>ðŸ‡ºðŸ‡¸ United States</option>
                <option value="CA">ðŸ‡¨ðŸ‡¦ Canada</option>
                <option value="MX">ðŸ‡²ðŸ‡½ Mexico</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label for="calculation_currency" class="form-label">Currency *</label>
              <select class="form-select" id="calculation_currency" name="calculation_currency" onchange="updateAllCurrencyDisplays()">
                <option value="USD" selected>USD</option>
                <option value="EUR">EUR</option>
                <option value="CNY">CNY</option>
                <option value="JPY">JPY</option>
                <option value="GBP">GBP</option>
                <option value="CAD">CAD</option>
                <option value="AUD">AUD</option>
                <option value="KRW">KRW</option>
                <option value="INR">INR</option>
                <option value="MXN">MXN</option>
                <option value="BRL">BRL</option>
                <option value="VND">VND</option>
                <option value="THB">THB</option>
                <option value="MYR">MYR</option>
                <option value="SGD">SGD</option>
                <option value="PHP">PHP</option>
                <option value="IDR">IDR</option>
                <option value="TWD">TWD</option>
                <option value="HKD">HKD</option>
                <option value="CHF">CHF</option>
                <option value="SEK">SEK</option>
                <option value="NOK">NOK</option>
                <option value="DKK">DKK</option>
                <option value="PLN">PLN</option>
              </select>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <label class="form-label">Method *</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="method_ad_valorem" name="method" value="ad_valorem" checked>
                  <label for="method_ad_valorem">
                    Ad Valorem
                    <span class="tooltip-icon" data-tooltip="Duty calculated per COO bucket: declared value Ã— effective IEEPA rate, then summed across all COO buckets in the package">i</span>
                  </label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="method_specific" name="method" value="specific">
                  <label for="method_specific">
                    Specific
                    <span class="tooltip-icon" data-tooltip="Duty based on highest IEEPA rate in package: <16% = $80, 16-25% = $160, >25% = $200 per package">i</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- COMPACT VERIFICATION SECTION -->
        <div class="verify-section">
          <div class="checkbox-container">
            <input type="checkbox" id="verify_description" name="verify_description">
            <label for="verify_description">
              Verify description
              <span class="tooltip-icon" data-tooltip="When enabled, the system will validate that product descriptions are detailed enough for accurate tariff classification. If a description is insufficient, you'll be prompted to improve it.">i</span>
            </label>
          </div>
          <div class="verify-info">
            When verification is enabled, descriptions that are too vague for accurate classification will be flagged, allowing you to improve them before calculation.
          </div>
        </div>

        <div class="products-section">
          <h3 class="section-title">Product Information</h3>

          <div class="table-responsive">
            <table class="table products-table">
              <thead>
                <tr>
                  <th style="width: 25%;">Description</th>
                  <th style="width: 15%;">Tariff Code</th>
                  <th style="width: 18%;">Country of Origin</th>
                  <th style="width: 10%;">Quantity</th>
                  <th style="width: 12%;">Item Value</th>
                  <th style="width: 12%;">Line Value</th>
                  <th style="width: 8%;">
                    <button type="button" class="btn-add-product" onclick="addRow()">Add</button>
                  </th>
                </tr>
              </thead>
              <tbody id="products-body"></tbody>
            </table>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-content">
            <span class="summary-title">Shipment Summary:</span>
            <span class="summary-item-compact">
              <span class="summary-label">Total Value:</span>
              <span class="summary-value" id="total_value_display">$0.00 (USD)</span>
            </span>
            <span class="summary-item-compact">
              <span class="summary-label">Items:</span>
              <span class="summary-value" id="total_items_display">0</span>
            </span>
          </div>
          <input type="hidden" id="total_value" name="total_value">
        </div>

        <button type="submit" class="calculate-btn">Calculate Customs & Duties</button>
      </form>
    </div>
  </div>

  <div id="results"></div>
  <div id="debug" style="margin-top: 1rem;"></div>

  <footer class="avalara-footer">
    Â© Avalara, Inc. 2025
  </footer>
</div>

<script>
// Country data
const COUNTRIES = [
  { code: "CN", name: "China", flag: "ðŸ‡¨ðŸ‡³" },
  { code: "US", name: "United States", flag: "ðŸ‡ºðŸ‡¸" },
  { code: "DE", name: "Germany", flag: "ðŸ‡©ðŸ‡ª" },
  { code: "JP", name: "Japan", flag: "ðŸ‡¯ðŸ‡µ" },
  { code: "GB", name: "United Kingdom", flag: "ðŸ‡¬ðŸ‡§" },
  { code: "FR", name: "France", flag: "ðŸ‡«ðŸ‡·" },
  { code: "IT", name: "Italy", flag: "ðŸ‡®ðŸ‡¹" },
  { code: "CA", name: "Canada", flag: "ðŸ‡¨ðŸ‡¦" },
  { code: "AU", name: "Australia", flag: "ðŸ‡¦ðŸ‡º" },
  { code: "KR", name: "South Korea", flag: "ðŸ‡°ðŸ‡·" },
  { code: "IN", name: "India", flag: "ðŸ‡®ðŸ‡³" },
  { code: "MX", name: "Mexico", flag: "ðŸ‡²ðŸ‡½" },
  { code: "BR", name: "Brazil", flag: "ðŸ‡§ðŸ‡·" },
  { code: "VN", name: "Vietnam", flag: "ðŸ‡»ðŸ‡³" },
  { code: "TH", name: "Thailand", flag: "ðŸ‡¹ðŸ‡­" },
  { code: "MY", name: "Malaysia", flag: "ðŸ‡²ðŸ‡¾" },
  { code: "SG", name: "Singapore", flag: "ðŸ‡¸ðŸ‡¬" },
  { code: "PH", name: "Philippines", flag: "ðŸ‡µðŸ‡­" },
  { code: "ID", name: "Indonesia", flag: "ðŸ‡®ðŸ‡©" },
  { code: "TW", name: "Taiwan", flag: "ðŸ‡¹ðŸ‡¼" },
  { code: "HK", name: "Hong Kong", flag: "ðŸ‡­ðŸ‡°" },
  { code: "CH", name: "Switzerland", flag: "ðŸ‡¨ðŸ‡­" },
  { code: "SE", name: "Sweden", flag: "ðŸ‡¸ðŸ‡ª" },
  { code: "NO", name: "Norway", flag: "ðŸ‡³ðŸ‡´" },
  { code: "DK", name: "Denmark", flag: "ðŸ‡©ðŸ‡°" },
  { code: "PL", name: "Poland", flag: "ðŸ‡µðŸ‡±" },
  { code: "ES", name: "Spain", flag: "ðŸ‡ªðŸ‡¸" },
  { code: "NL", name: "Netherlands", flag: "ðŸ‡³ðŸ‡±" },
  { code: "BE", name: "Belgium", flag: "ðŸ‡§ðŸ‡ª" },
  { code: "AT", name: "Austria", flag: "ðŸ‡¦ðŸ‡¹" }
];

// Currency data with symbols
const CURRENCIES = [
  { code: "USD", symbol: "$", name: "US Dollar" },
  { code: "EUR", symbol: "â‚¬", name: "Euro" },
  { code: "CNY", symbol: "Â¥", name: "Chinese Yuan" },
  { code: "JPY", symbol: "Â¥", name: "Japanese Yen" },
  { code: "GBP", symbol: "Â£", name: "British Pound" },
  { code: "CAD", symbol: "C$", name: "Canadian Dollar" },
  { code: "AUD", symbol: "A$", name: "Australian Dollar" },
  { code: "KRW", symbol: "â‚©", name: "South Korean Won" },
  { code: "INR", symbol: "â‚¹", name: "Indian Rupee" },
  { code: "MXN", symbol: "Mex$", name: "Mexican Peso" },
  { code: "BRL", symbol: "R$", name: "Brazilian Real" },
  { code: "VND", symbol: "â‚«", name: "Vietnamese Dong" },
  { code: "THB", symbol: "à¸¿", name: "Thai Baht" },
  { code: "MYR", symbol: "RM", name: "Malaysian Ringgit" },
  { code: "SGD", symbol: "S$", name: "Singapore Dollar" },
  { code: "PHP", symbol: "â‚±", name: "Philippine Peso" },
  { code: "IDR", symbol: "Rp", name: "Indonesian Rupiah" },
  { code: "TWD", symbol: "NT$", name: "Taiwan Dollar" },
  { code: "HKD", symbol: "HK$", name: "Hong Kong Dollar" },
  { code: "CHF", symbol: "Fr", name: "Swiss Franc" },
  { code: "SEK", symbol: "kr", name: "Swedish Krona" },
  { code: "NOK", symbol: "kr", name: "Norwegian Krone" },
  { code: "DKK", symbol: "kr", name: "Danish Krone" },
  { code: "PLN", symbol: "zÅ‚", name: "Polish Zloty" }
];

// Static exchange rates to USD
const EXCHANGE_RATES = {
  USD: 1.00, EUR: 0.85, CNY: 7.25, JPY: 149.50, GBP: 0.73,
  CAD: 1.37, AUD: 1.52, KRW: 1320.00, INR: 83.20, MXN: 17.25,
  BRL: 5.05, VND: 24500.00, THB: 35.80, MYR: 4.65, SGD: 1.35,
  PHP: 56.20, IDR: 15750.00, TWD: 31.50, HKD: 7.82, CHF: 0.88,
  SEK: 10.85, NOK: 10.75, DKK: 6.85, PLN: 4.05
};

// Convert currency
function convertCurrency(amount, from, to = 'USD') {
  if (from === to) return amount;
  const fromRate = EXCHANGE_RATES[from] || 1;
  const toRate = EXCHANGE_RATES[to] || 1;
  return (amount / fromRate) * toRate;
}

// Get currency symbol
function getCurrencySymbol(code) {
  const currency = CURRENCIES.find(c => c.code === code);
  return currency ? currency.symbol : code;
}

// Get selected calculation currency
function getCalculationCurrency() {
  return document.getElementById('calculation_currency').value;
}

// Update all currency displays when global currency changes
function updateAllCurrencyDisplays() {
  updateTotals();
  const valueInputs = document.querySelectorAll('input[name="per_unit_value"]');
  const currency = getCalculationCurrency();

  valueInputs.forEach(input => {
    if (!input.value || input.value === '0.00') {
      input.placeholder = `0.00 ${currency}`;
    }
  });
}

// Set today's date and add initial row
document.addEventListener('DOMContentLoaded', function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('entry_date').value = today;
  addRow();
});

function addRow() {
  const table = document.getElementById("products-body");
  const row = document.createElement("tr");
  row.className = "product-row";

  const countryOptions = COUNTRIES.map(c =>
    `<option value="${c.code}" ${c.code === "CN" ? "selected" : ""}>${c.flag} ${c.name}</option>`
  ).join("");

  const currency = getCalculationCurrency();

  row.innerHTML = `
    <td>
      <input name="description" class="form-control" placeholder="e.g., Men's cotton shirt" onblur="fetchHSCode(this)" required>
      <div class="description-warning"></div>
    </td>
    <td><input name="hs_code" class="form-control" placeholder="Auto-filled" oninput="onHSCodeManualEntry(this)"></td>
    <td><select name="coo" class="form-select">${countryOptions}</select></td>
    <td><input name="quantity" type="number" value="1" class="form-control" min="1" required onchange="updateLineValue(this)"></td>
    <td><input name="per_unit_value" type="number" step="0.01" class="form-control" value="0.00" placeholder="0.00 ${currency}" required onchange="updateLineValue(this)"></td>
    <td><input name="line_value" type="text" class="form-control" readonly value="0.00" style="background-color: #f5f7fa;"></td>
    <td><button type="button" class="btn-remove" onclick="removeRow(this)">Ã—</button></td>
  `;

  table.appendChild(row);
  updateTotals();
  updateRemoveButtons();
}

function removeRow(button) {
  button.closest('tr').remove();
  updateTotals();
  updateRemoveButtons();
}

function updateRemoveButtons() {
  const rows = document.querySelectorAll("#products-body tr");
  const removeButtons = document.querySelectorAll(".btn-remove");
  removeButtons.forEach(button => {
    if (rows.length <= 1) {
      button.disabled = true;
      button.style.opacity = '0.5';
    } else {
      button.disabled = false;
      button.style.opacity = '1';
    }
  });
}

function updateLineValue(input) {
  const row = input.closest("tr");
  const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
  const perUnitValue = parseFloat(row.querySelector('input[name="per_unit_value"]').value) || 0;
  const lineValueInput = row.querySelector('input[name="line_value"]');
  const lineValue = quantity * perUnitValue;

  lineValueInput.value = lineValue.toFixed(2);
  updateTotals();
}

function updateTotals() {
  const rows = document.querySelectorAll("#products-body tr");
  let totalValue = 0;
  let totalItems = 0;
  const currency = getCalculationCurrency();
  const symbol = getCurrencySymbol(currency);

  Array.from(rows).forEach(row => {
    const lineValueText = row.querySelector('input[name="line_value"]').value || '0.00';
    const lineValue = parseFloat(lineValueText.replace(/[^\d.-]/g, '')) || 0;
    const quantity = parseFloat(row.querySelector('input[name="quantity"]').value || 0);

    totalValue += lineValue;
    totalItems += quantity;
  });

  document.getElementById("total_value_display").textContent = `${symbol}${totalValue.toFixed(2)} (${currency})`;
  document.getElementById("total_items_display").textContent = totalItems.toString();

  // Store total value in USD for backend processing
  const totalValueUSD = convertCurrency(totalValue, currency, 'USD');
  document.getElementById("total_value").value = totalValueUSD.toFixed(2);
}

async function fetchHSCode(input) {
  const row = input.closest("tr");
  const desc = input.value;
  const coo = row.querySelector('select[name="coo"]').value;
  const hsField = row.querySelector('input[name="hs_code"]');
  const warningDiv = row.querySelector('.description-warning');
  const verifyEnabled = document.getElementById('verify_description').checked;

  if (!desc || !hsField) return;

  warningDiv.classList.remove('show');
  warningDiv.textContent = '';
  hsField.placeholder = "Loading...";
  hsField.style.backgroundColor = "#f5f7fa";

  try {
    const response = await fetch("/fetch_hs_code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        description: desc,
        coo: coo,
        verify_description: verifyEnabled
      })
    });

    const json = await response.json();

    if (json.hs_code) {
      hsField.value = json.hs_code;
      hsField.style.backgroundColor = "#d1fae5";
      hsField.setAttribute('readonly', true);
    } else if (json.verification_failed && verifyEnabled) {
      hsField.value = '';
      hsField.removeAttribute('readonly');
      hsField.placeholder = "Enter HS code manually";
      hsField.style.backgroundColor = "#fef3c7";
      warningDiv.textContent = "âš ï¸ Description needs more details. Enter HS code manually or improve description.";
      warningDiv.classList.add('show');
      setTimeout(() => hsField.focus(), 100);
    } else {
      hsField.placeholder = "Not found";
      hsField.style.backgroundColor = "#fee2e2";
    }
  } catch (err) {
    hsField.placeholder = "Error";
    hsField.style.backgroundColor = "#fee2e2";
  }
}

function onHSCodeManualEntry(input) {
  const row = input.closest("tr");
  const warningDiv = row.querySelector('.description-warning');

  if (input.value.trim()) {
    input.style.backgroundColor = "#dbeafe";
    warningDiv.classList.remove('show');
    warningDiv.textContent = '';
  }
}

document.getElementById("duty-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const verifyEnabled = document.getElementById('verify_description').checked;
  const rows = document.querySelectorAll("#products-body tr");
  let hasInsufficientDescriptions = false;

  if (verifyEnabled) {
    Array.from(rows).forEach(row => {
      const hsCode = row.querySelector('input[name="hs_code"]').value;
      if (!hsCode) {
        hasInsufficientDescriptions = true;
      }
    });

    if (hasInsufficientDescriptions) {
      alert('Please improve product descriptions that are flagged as insufficient before calculating duties.');
      return;
    }
  }

  const totalValueUSD = parseFloat(document.getElementById("total_value").value);
  if (totalValueUSD > 2500) {
    alert('Total shipment value exceeds $2,500 USD. Postal method not available.');
    return;
  }

  const submitBtn = document.querySelector('.calculate-btn');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Calculating...';
  submitBtn.disabled = true;

  const entry_date = document.getElementById("entry_date").value;
  const method = document.querySelector('input[name="method"]:checked').value;
  const destination_country = document.getElementById("destination_country").value;
  const calculation_currency = getCalculationCurrency();

  const products = Array.from(rows).map((row, index) => {
    const description = row.querySelector('input[name="description"]').value;
    const hs_code = row.querySelector('input[name="hs_code"]').value;
    const coo = row.querySelector('select[name="coo"]').value;
    const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
    const per_unit_value = parseFloat(row.querySelector('input[name="per_unit_value"]').value);
    const lineValueText = row.querySelector('input[name="line_value"]').value;
    const line_value = parseFloat(lineValueText.replace(/[^\d.-]/g, '')) || 0;

    // Convert to USD for backend processing
    const per_unit_value_usd = convertCurrency(per_unit_value, calculation_currency, 'USD');
    const line_value_usd = convertCurrency(line_value, calculation_currency, 'USD');

    return {
      description: description,
      hs_code: hs_code,
      coo: coo,
      currency: calculation_currency,
      quantity: quantity,
      per_unit_value: per_unit_value_usd,
      line_value: line_value_usd,
      original_per_unit_value: per_unit_value,
      original_line_value: line_value,
      exchange_rate: EXCHANGE_RATES[calculation_currency]
    };
  });

  const payload = {
    entry_date,
    method,
    destination_country,
    calculation_currency,
    products,
    total_value: totalValueUSD,
    verify_description: verifyEnabled,
    exchange_rates: EXCHANGE_RATES
  };

  try {
    const res = await fetch("/calculate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    displayResults(json);
  } catch (error) {
    document.getElementById("results").innerHTML = `<div class="alert alert-danger">Calculation failed: ${error.message}</div>`;
    document.getElementById("debug").innerHTML = "";
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

function displayResults(json) {
  const resultsContainer = document.getElementById("results");
  const debugContainer = document.getElementById("debug");
  const calculation_currency = getCalculationCurrency();
  const currencySymbol = getCurrencySymbol(calculation_currency);

  if (json.error) {
    resultsContainer.innerHTML = `
      <div class="results-section">
        <div class="alert alert-danger">
          <strong>Calculation Error:</strong> ${json.error}
        </div>
      </div>`;
    debugContainer.innerHTML = json.debug ? `<pre style="background: #f5f7fa; padding: 1rem; border-radius: 8px; font-size: 0.85rem; border: 1px solid #E5E7EB;">${json.debug}</pre>` : "";
    return;
  }

  // Convert duty amounts to selected currency
  const convertedResults = json.results.map(r => ({
    ...r,
    duty_in_selected_currency: convertCurrency(r.duty, 'USD', calculation_currency)
  }));

  const total_duty_in_selected_currency = convertCurrency(json.total_duty, 'USD', calculation_currency);

  resultsContainer.innerHTML = `
    <div class="results-section">
      <h3 class="section-title">Calculation Results</h3>

      <div class="table-responsive">
        <table class="table results-table">
          <thead>
            <tr>
              <th>Description</th>
              <th>Tariff Code</th>
              <th>COO</th>
              <th>Qty</th>
              <th>Unit Value</th>
              <th>Line Value</th>
              <th>Rate Breakdown</th>
              <th>Total Rate</th>
              <th>Total Duty</th>
            </tr>
          </thead>
          <tbody>
            ${convertedResults.map(r => `
              <tr>
                <td>${r.description}</td>
                <td>${r.hs_code}</td>
                <td>${r.coo}</td>
                <td>${r.quantity}</td>
                <td>${currencySymbol}${(r.original_per_unit_value || r.per_unit_value).toFixed(2)}</td>
                <td>${currencySymbol}${(r.original_line_value || r.line_value).toFixed(2)}</td>
                <td style="font-size: 0.8rem;">
                  ${r.rate_breakdown ? r.rate_breakdown.map(breakdown =>
                    `<div style="margin-bottom: 0.25rem;">
                      <strong>${breakdown.rate_type}:</strong> ${breakdown.rate}%
                      ${breakdown.description ? `<br><span style="color: #6B7280; font-size: 0.75rem;">${breakdown.description}</span>` : ''}
                    </div>`
                  ).join('') :
                    `<div><strong>Base Rate:</strong> ${r.total_rate}%</div>`
                  }
                </td>
                <td><strong>${r.total_rate}%</strong></td>
                <td><strong>${currencySymbol}${r.duty_in_selected_currency.toFixed(2)}</strong></td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>

      <div class="row mt-4 align-items-stretch">
        <div class="col-md-6">
          <div style="background: linear-gradient(135deg, #FAFBFC 0%, #F3F4F6 100%); padding: 2rem; border-radius: 12px; border: 2px solid #E5E7EB; height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <p style="margin: 0 0 1rem 0;"><strong>Method:</strong> ${json.logic_applied}</p>
            <p style="margin: 0;"><strong>Currency:</strong> ${calculation_currency}</p>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: linear-gradient(135deg, #004459 0%, #056BA6 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center; box-shadow: 0 6px 20px rgba(0, 68, 89, 0.25); height: 100%; display: flex; flex-direction: column; justify-content: center;">
            <h4 style="margin: 0 0 0.75rem 0; font-weight: 600; font-size: 1.125rem;">Total Customs Duty</h4>
            <div style="font-size: 2.25rem; font-weight: 700; margin: 0.5rem 0;">${currencySymbol}${total_duty_in_selected_currency.toFixed(2)}</div>
            <div style="font-size: 0.8rem; opacity: 0.9; margin: 0;">${calculation_currency}</div>
          </div>
        </div>
      </div>

      ${json.savings_recommendation ? `
        <div class="row mt-4">
          <div class="col-12">
            <div style="background: linear-gradient(135deg, rgba(255, 102, 0, 0.03) 0%, rgba(250, 251, 252, 1) 100%); border: 2px solid #E5E7EB; border-left: 6px solid #FF6600; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 102, 0, 0.08);">
              <div class="d-flex align-items-center mb-3">
                <div style="background: linear-gradient(135deg, #FF6600 0%, #FF8533 100%); color: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-right: 16px; box-shadow: 0 3px 10px rgba(255, 102, 0, 0.25);">ðŸ’¡</div>
                <h5 style="margin: 0; color: #004459; font-weight: 700; font-size: 1.25rem;">Money-Saving Opportunity!</h5>
              </div>
              <div class="row align-items-center">
                <div class="col-md-8">
                  <p style="margin: 0 0 0.75rem 0; color: #004459; line-height: 1.5; font-size: 1rem; font-weight: 600;">
                    <span style="color: #FF6600;">Alternative Method:</span> ${json.savings_recommendation.method}
                  </p>
                  <p style="margin: 0; color: #6B7280; font-size: 0.95rem; line-height: 1.5; font-weight: 400;">
                    ${json.savings_recommendation.reason}
                  </p>
                </div>
                <div class="col-md-4">
                  <div style="background: linear-gradient(135deg, #004459 0%, #056BA6 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 6px 20px rgba(0, 68, 89, 0.25); border: 2px solid #004459;">
                    <div style="font-size: 0.85rem; opacity: 0.95; margin-bottom: 0.5rem; font-weight: 500;">You could save</div>
                    <div style="font-size: 1.5rem; font-weight: 800; margin: 0.5rem 0;">${currencySymbol}${convertCurrency(json.savings_recommendation.savings, 'USD', calculation_currency).toFixed(2)}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.5rem; font-weight: 400;">Alternative: ${currencySymbol}${convertCurrency(json.savings_recommendation.alternative_duty, 'USD', calculation_currency).toFixed(2)}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      ` : ''}
    </div>

    ${json.duty_rate_breakdowns ? `
      <div class="duty-breakdown-section">
        <h3 class="duty-breakdown-title">Duty Rate Calculation Breakdown</h3>
        ${json.duty_rate_breakdowns.map(breakdown => `
          <div class="product-breakdown">
            <div class="product-breakdown-header">
              ${breakdown.product_description} (${breakdown.hs_code}) from ${breakdown.country_of_origin}
            </div>
            <table class="breakdown-table">
              <thead>
                <tr>
                  <th>Stackable HS Code</th>
                  <th>Description</th>
                  <th style="text-align: right;">Rate</th>
                </tr>
              </thead>
              <tbody>
                ${breakdown.stackable_codes.map(code => `
                  <tr>
                    <td><a href="#" class="hs-code-link">${code.hs_code}</a></td>
                    <td>${code.description}</td>
                    <td class="rate-cell">${code.rate}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="breakdown-summary">
              <div class="summary-row">
                <span class="summary-label">Total Combined Rate:</span>
                <span class="summary-amount total-rate">${breakdown.total_rate}%</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Applied to Line Value (${currencySymbol}${convertCurrency(breakdown.line_value, 'USD', calculation_currency).toFixed(2)}):</span>
                <span class="summary-amount duty-amount">${currencySymbol}${convertCurrency(breakdown.duty_amount, 'USD', calculation_currency).toFixed(2)}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    ` : ''}
  `;

  debugContainer.innerHTML = json.debug ?
    `<details style="background: #f5f7fa; padding: 1.5rem; border-radius: 12px; margin-top: 1rem; border: 1px solid #E5E7EB;">
      <summary style="cursor: pointer; font-weight: 600; color: #004459;">Debug Information</summary>
      <pre style="margin-top: 1rem; font-size: 0.85rem; white-space: pre-wrap; color: #374151;">${json.debug}</pre>
    </details>` : "";
}
</script>

</body>
</html>